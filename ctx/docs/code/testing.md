# Code Testing — Invariants

Path: `./ctx/docs/code/testing.md`

## Назначение

Документ фиксирует жёсткие инженерные инварианты тестирования кодового слоя проекта Mindstream.

Тесты рассматриваются как равноправная часть кодовой базы, а не как вспомогательные или обслуживающие артефакты. Нарушение положений данного документа считается дефектом.

Документ не является руководством по написанию тестов и не описывает конкретные тестовые сценарии.

---

## Статус тестов в проекте

Тесты являются частью кодового слоя одного уровня с production-кодом. Для всех `.mjs`-модулей backend и frontend наличие unit-тестов считается нормой по умолчанию. Отсутствие тестов допускается только для точек входа (entrypoints) и явно зафиксированных стабильных интерфейсов.

---

## Namespace и зоны тестирования

Тесты используют те же пространства имён, что и production-код: `Mindstream_Back_`, `Mindstream_Web_`, `Mindstream_Shared_`.

Введение test-only namespace (например, `Mindstream_Test_*`) не допускается. Тесты проверяют код в тех же namespace-границах, в которых он используется в production.

---

## DI и Composition Root в тестах

Каждый unit-тест создаёт собственный DI-контейнер. DI-контейнер не переиспользуется между тестами. Все тесты выполняются в test mode (`enableTestMode()`).

### Test Composition Root

Для тестов используется отдельный composition root, независимый от production. Конфигурация resolver’а может быть минимальной, достаточной для целей конкретного теста. Helper-модули должны быть чистыми фабриками контейнеров, не вносить неиспользуемые зависимости и не скрывать конфигурацию DI.

---

## Импорт и доступ к коду в тестах

В тестах запрещено статически импортировать production-код из `src/` и `web/app/`, напрямую импортировать production-модули даже для проверки формы, а также обходить DI-контейнер любыми способами.

Статический импорт допускается только для тестовых helper’ов, фикстур, snapshot-данных и стандартных Node.js-модулей (`node:*`). Доступ к production-коду осуществляется исключительно через DI-контейнер (`container.get(...)`).

Тест, обходящий DI-контейнер, не считается валидным тестом проекта.

---

## Platform API и side effects

Реальные side effects в тестах запрещены, включая файловую систему, сеть, сокеты, таймеры и фоновые процессы. Любой доступ к platform API осуществляется только через DI. Мокирование platform-зависимостей допускается свободно.

---

## Типы тестов

В рамках MVP допускаются только unit-тесты. Интеграционные, e2e, snapshot-, property-based и fuzz-тесты не используются.

---

## Инструменты тестирования

Нормативный стек тестирования: `node:test`, `node:assert/strict`.

Использование сторонних библиотек допускается только по явному согласованию с человеком. Предпочтение отдаётся стандартным средствам Node.js.

---

## Логирование в тестах

Использование production-логгера в unit-тестах не является обязательным. Допускается использование `console.log` для диагностических целей. Логи тестов не являются частью проверяемого контракта, не используются для assertions и рассматриваются исключительно как отладочный вывод.

---

## Идемпотентность и изоляция

Каждый тест обязан быть идемпотентным и не оставлять следов своего выполнения. Если тест изменяет глобальное состояние (`process`, `window`, `document`), он обязан восстановить его в `finally`. Использование shared state внутри одного test-файла допускается при условии логической изоляции тестов.

---

## Web-тесты

Тестирование frontend-кода выполняется в Node.js. Реальный браузер и e2e-тесты в MVP отсутствуют. Эмуляция browser API выполняется исключительно через ручные mock-объекты, внедряемые через DI. Использование `jsdom`, `happy-dom` и аналогичных библиотек не допускается.

---

## Статус документа

Положения данного документа являются жёсткими инженерными инвариантами. Нарушение любого из требований считается дефектом кодовой базы и не трактуется как рекомендация, стиль или технический долг.
