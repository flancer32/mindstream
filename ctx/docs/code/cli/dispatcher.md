# Code CLI — Dispatcher Model

Path: `ctx/docs/code/cli/dispatcher.md`

## Назначение

Документ фиксирует нормативную модель диспетчеризации CLI в MVP Mindstream.

Он определяет:

- модель дерева CLI;
- правила определения роли CLI-модуля;
- границы ответственности диспетчеров;
- модель выполнения команд;
- семантику ошибок и завершения процесса.

Документ специализированный и опирается на рамочную модель, заданную в `code/cli/overview.md`. Любое отклонение от зафиксированной модели считается дефектом реализации.

---

## Модель CLI

CLI в Mindstream реализован как дерево CLI-модулей.

- корень дерева — корневой диспетчер приложения;
- внутренние узлы дерева выполняют роль диспетчеров;
- листья дерева являются исполняемыми командами.

Плоский реестр команд и централизованная таблица маршрутизации не используются.

---

## Корневой диспетчер

Корневым диспетчером CLI является:

`Mindstream_Back_App_Cli_Dispatcher`

Корневой диспетчер:

- является частью backend-приложения;
- инициирует CLI-диспетчеризацию;
- не содержит прикладной логики команд;
- работает исключительно через DI-контур.

---

## Роль CLI-модуля

CLI-модуль может выполнять одну из ролей:

- диспетчер;
- команда.

Роль CLI-модуля определяется исключительно его положением в дереве CLI и структурой каталогов.

Именование классов, наследование, суффиксы и маркеры в коде для определения роли не используются.

---

## Правило определения роли

Для каталога `src/Cli/<Path>/` применяются следующие правила:

1. Если каталог содержит подкаталоги, модуль `<Path>.mjs` является диспетчером и обязан делегировать выполнение в один из подкаталогов.
2. Если каталог не содержит подкаталогов, все модули в данном каталоге являются командами и считаются листьями дерева CLI.

---

## Ответственность диспетчера

Диспетчер:

- выбирает следующий узел дерева CLI;
- делегирует выполнение;
- перехватывает ошибки.

Диспетчер не:

- разбирает аргументы;
- валидирует параметры;
- выполняет прикладную логику;
- управляет инфраструктурой;
- управляет завершением процесса.

---

## DI и пространство CLI

Все CLI-модули:

- предоставляются через DI-контейнер;
- не создаются вручную;
- не регистрируются динамически.

Пространство доступных CLI-команд определяется совокупностью структуры каталогов `src/Cli` и состава объектов, доступных через DI.

---

## Исполняемые команды

Команда является листовым модулем дерева CLI.

Команда:

- получает зависимости через DI;
- самостоятельно разбирает аргументы CLI;
- реализует один метод выполнения `execute`;
- не управляет завершением процесса напрямую.

Команда рассматривается как pure-операция с побочными эффектами без формализованного внутреннего состояния.

---

## Ошибки и завершение

### Сигнализация ошибок

Команда сигнализирует об ошибке через исключение.

---

### Exit semantics

Exit semantics централизованы.

- `0` — успешное завершение инженерной команды;
- ненулевое значение — ошибка.

Exit semantics применяются только к результату выполнения листовой CLI-команды.  
Промежуточные диспетчеры не имеют собственного результата выполнения и не формируют exit code.

---

### Runtime-команды

Runtime-команды:

- являются листовыми узлами дерева CLI;
- инициируют runtime-режим приложения;
- не предполагают нормального завершения;
- не используют exit code как индикатор успеха.

Возврат управления из runtime-команды считается нештатной ситуацией.

---

## Логирование

- команда может логировать ошибки самостоятельно;
- промежуточные диспетчеры могут перехватывать и передавать ошибки выше;
- корневой диспетчер обязан логировать все ошибки, не обработанные на нижележащих уровнях.

Отсутствие логов при аварийном завершении CLI считается дефектом.

---

## Инварианты CLI (MVP)

Для всех CLI-команд в MVP зафиксированы следующие свойства:

- детерминированность;
- неидемпотентность по умолчанию;
- строгая неинтерактивность;
- работа в доверенном контуре.

---

## Границы документа

Документ не описывает:

- синтаксис CLI;
- формат аргументов;
- help и usage;
- автогенерацию CLI;
- список команд MVP;
- реализацию в коде.
