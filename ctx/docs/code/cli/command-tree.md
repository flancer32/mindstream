# Code CLI — Command Tree

Path: `ctx/docs/code/cli/command-tree.md`

## Назначение

Документ фиксирует каноническое пространство допустимых CLI-команд backend-приложения Mindstream. Он определяет иерархию команд, их назначение и форму входных параметров. Документ является нормативным и представляет скелет CLI-пространства; код CLI обязан соответствовать данному реестру.

---

## Иерархия команд

```
db:schema:create
db:schema:renew
ingest:discover:habr
ingest:extract:habr
process:generate:summaries
runtime:serve
```

Команды, отсутствующие в данной иерархии, считаются недопустимыми.

---

## Реестр команд

### db:schema:create

Контур: maintenance.

Назначение: создание схемы данных приложения в пустой базе данных.

Параметры:

- отсутствуют.

Ограничения:

- предполагает пустую базу данных;
- создаёт только структуру БД (tables, indexes, constraints);
- не идемпотентна;
- не выполняет миграции;
- не используется в runtime-контуре.

---

### db:schema:renew

Контур: maintenance.

Назначение: полное пересоздание схемы данных приложения с попыткой best-effort переноса данных из существующей базы данных.

Параметры:

- отсутствуют.

Ограничения:

- destructive-операция без подтверждений и без интерактивности;
- работает строго с одной базой данных из конфигурации приложения;
- пересоздаёт схему исключительно на основе `Mindstream_Back_Storage_Schema`;
- фиксирует новую схему в `schema_version` после успешного создания;
- при переносе данных сопоставляет таблицы и колонки по именам, отбрасывает лишние структуры и пытается привести типы;
- при ошибке восстановления данных завершается с ошибкой без частичного успеха.

---

### ingest:discover:habr

Контур: ingest.

Назначение: обнаружение публикаций из RSS Хабра и фиксация их в системе как известных публикаций без загрузки текста и без инициирования processing.

Параметры:

- отсутствуют.

Ограничения:

- использует хардкодированный RSS URL источника Habr;
- выполняет только discovery;
- не выполняет fetch HTML;
- не извлекает текст публикаций;
- идемпотентна;
- допускает повторные запуски без изменения результата;
- не инициирует processing и не влияет на runtime-контур.

### ingest:extract:habr

Контур: ingest.

Назначение: получение HTML публикаций Хабра и извлечение md-текста в рамках ingestion-контура без инициирования последующих этапов обработки.

Параметры:

- отсутствуют.

Ограничения:

- извлекает md-текст только для публикаций со статусом ожидания извлечения;
- сохраняет HTML и md-текст как временные артефакты ingestion-контура;
- использует source-specific извлечение для Habr;
- идемпотентна и допускает повторные запуски без изменения результата;
- не инициирует processing и не влияет на runtime-контур.

#### process:generate:summaries

Контур: processing (engineering).

Назначение: каноническая генерация смысловых представлений публикаций — обзора и аннотации — для всех публикаций, для которых эти представления ещё не сформированы.

Параметры:

- отсутствуют.

Ограничения:

- команда обрабатывает **только** публикации, для которых отсутствуют аннотация и обзор;
- генерация выполняется **строго на основе нормализованного md-текста публикации**;
- источник публикации не учитывается и не влияет на результат;
- в рамках одной публикации всегда формируются **оба** артефакта: сначала обзор, затем аннотация в том же диалоге с LLM;
- результат генерации считается **каноническим и неизменяемым** в рамках MVP;
- повторная генерация для уже обработанных публикаций запрещена;
- при ошибке генерации команда:
  - фиксирует ошибку в логах,
  - переводит публикацию в ошибочное состояние,
  - не выпускает публикацию в пользовательскую ленту;
- публикации без успешно сформированных аннотации и обзора **не считаются готовыми** и не участвуют в runtime-контуре;
- команда не инициирует embedding, runtime или иные последующие этапы обработки;
- команда не является интерактивной и не принимает входных параметров.

### runtime:serve

Контур: runtime.

Назначение: запуск backend-приложения в runtime-режиме.

Параметры:

- отсутствуют.

Ограничения:

- не является операцией с результатом;
- не предполагает нормального завершения;
- не используется в maintenance-контуре.

---

## Общие инварианты CLI-команд

Для всех CLI-команд приложения зафиксированы следующие инварианты:

- команды строго неинтерактивны;
- команды детерминированы при фиксированном окружении и данных;
- команды работают в доверенном контуре;
- команды не управляют завершением процесса напрямую.

---

## Границы документа

Документ не описывает бизнес-логику команд, алгоритмы выполнения, побочные эффекты, реализацию в коде, порядок вызова внутренних сервисов или формат пользовательского вывода. Любые изменения пространства CLI-команд требуют явного изменения данного документа.
