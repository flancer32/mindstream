# Code Storage Layer — Overview

Path: `ctx/docs/code/storage/overview.md`

## Назначение

Документ фиксирует **инженерную роль и форму слоя работы с реляционной базой данных** в MVP Mindstream.

Слой хранения данных (`storage`) относится исключительно к уровню `code/` и реализует архитектурный контур `Storage`, уже зафиксированный в архитектурной документации, **без расширения или изменения архитектуры системы**.

Документ описывает, что считается DB-слоем как инженерным объектом, какие обязанности он выполняет и какие инварианты считаются обязательными в рамках MVP.

---

## Архитектурная позиция слоя

DB-слой:

- не является архитектурным контуром;
- не вводит новых потоков данных;
- не расширяет архитектурную модель хранения;
- реализует существующий архитектурный контур `Storage` на инженерном уровне.

Все архитектурные свойства `Storage` (каноничность, монотонность, отсутствие реактивности и управляющих обратных связей) считаются **заданными извне** и не формулируются повторно в данном слое.

---

## Роль DB-слоя в кодовой базе

DB-слой выполняет следующие инженерные обязанности:

- реализация операций CRUD + L для канонических сущностей хранения;
- управление схемой данных на уровне кодового слоя;
- обеспечение воспроизводимости структуры базы данных;
- поддержка контролируемого пересоздания схемы с сохранением данных;
- изоляция прикладного кода от деталей SQL и конкретной СУБД.

DB-слой не содержит продуктовой логики, не интерпретирует сигналы внимания и не участвует в формировании персональной ленты.

---

## Технологическая база

В рамках MVP Mindstream:

- используется `knex` как **единственный DBAL**;
- прямое использование SQL вне `knex` запрещено;
- код DB-слоя не зависит от конкретной СУБД и должен быть совместим с любыми СУБД, поддерживаемыми `knex` (PostgreSQL, MySQL/MariaDB, SQLite и т.п.).

Выбор конкретной СУБД относится к среде исполнения и не влияет на форму DB-слоя.

---

## Модель схемы данных

Схема данных:

- описывается **декларативно** в виде JS-описаний;
- рассматривается как **канонический источник истины** о структуре базы данных;
- не выводится из кода и не формируется как побочный эффект выполнения приложения.

DB-слой обязан поддерживать возможность **полного восстановления схемы данных** из декларативного описания без доступа к текущему состоянию базы данных.

---

## Управление жизненным циклом схемы

DB-слой отвечает за операции управления схемой данных как за отдельную инженерную обязанность.

В рамках MVP допускаются:

- пересоздание схемы базы данных;
- пересборка схемы с сохранением существующих данных;
- ручное выполнение destructive-операций над схемой.

Все destructive-операции:

- выполняются **только в ручном режиме**;
- инициируются через CLI или явный инженерный вызов;
- не являются частью обычного runtime-приложения;
- не инициируются автоматически в процессе работы системы.

В эксплуатационном режиме системы состояние `Storage` считается монотонным.

---

## Domain и persistence

В рамках MVP допускается **однозначное соответствие (1:1)** между:

- domain-сущностями;
- persistence-моделью (таблицы, поля, индексы).

Отдельный слой маппинга domain ↔ persistence отсутствует.

Domain-сущности рассматриваются как канонические структуры данных, а не как rich domain model с инкапсулированным поведением.

---

## Контракты доступа к данным

Операции CRUD + L реализуются через **предметно-явные контракты**, специфичные для каждой сущности хранения.

Обобщённые репозитории и generic-контракты в рамках MVP не используются.

Каждый storage-модуль:

- отвечает за одну конкретную сущность;
- реализует только необходимые для неё операции;
- использует `knex` напрямую внутри своей реализации.

---

## Тестируемость

DB-слой проектируется с приоритетом на unit-тестирование.

В рамках MVP:

- unit-тесты DB-слоя выполняются с полностью замоканным DBAL;
- реальные подключения к СУБД в unit-тестах не используются;
- side effects (файловая система, сеть, реальная БД) исключены.

Интеграционные тесты DB-слоя находятся вне рамок MVP.

---

## Границы документа

Документ не описывает:

- конкретные таблицы и поля;
- SQL-структуры и индексы;
- API прикладных сервисов;
- CLI-интерфейсы и команды;
- реализацию конкретных storage-модулей.

Данные вопросы относятся к последующим документам уровня `code/storage/`.

---

## Итог

DB-слой MVP Mindstream является инженерным слоем кодовой базы, реализующим архитектурный контур `Storage` без его расширения, обеспечивающим декларативное описание схемы данных, предметно-явные CRUD + L контракты и контролируемое управление жизненным циклом схемы в рамках MVP.
