# Code Storage Layer — Schema Declaration

Path: `ctx/docs/code/storage/schema.md`

## Назначение

Документ фиксирует **нормативную форму декларативного описания схемы данных** для DB-слоя MVP Mindstream.

Схема данных рассматривается как **канонический источник истины** о структуре реляционной базы данных и используется агентами и кодом DB-слоя для воспроизводимого создания, пересоздания и эволюции структуры хранения.

Документ описывает **мета-уровень схемы**: допустимую форму декларации, обязательные элементы, инварианты и границы ответственности. Конкретные сущности и таблицы в документе не вводятся.

---

## Статус схемы как источника истины

Декларативная схема является **единственным источником истины** о структуре базы данных.

В декларации **обязаны** быть явно описаны:

- таблицы;
- колонки и их типы;
- первичные ключи;
- внешние ключи;
- уникальные ограничения;
- NOT NULL и CHECK constraints;
- индексы.

Любая структура, существующая в БД и отсутствующая в декларации, считается **дефектом**.

Ручное изменение схемы базы данных без отражения в декларативной схеме **запрещено**, включая dev-эксперименты.

---

## Формат декларативного описания

Схема данных описывается в виде **чистой декларативной JSON-структуры**, без выполнения кода.

Требования к формату:

- декларация не содержит исполняемой логики;
- не допускаются условия (`if`), циклы, вычисления;
- декларация представляет собой данные, а не код;
- применение схемы (DDL) осуществляется DB-слоем, а не декларацией.

---

## Композиция схемы

Схема формируется как **единая логическая структура**, собираемая из отдельных декларативных фрагментов.

Допускается:

- разбиение схемы на несколько файлов;
- группировка деклараций по функциональному или предметному признаку;
- сборка итоговой схемы через композицию фрагментов.

Итоговая схема должна быть однозначно восстанавливаема как единый декларативный объект.

---

## Гранулярность схемы

Атомом декларации схемы является **таблица**.

Каждая декларация таблицы описывает:

- имя таблицы;
- набор колонок;
- первичный ключ;
- внешние ключи;
- ограничения;
- индексы.

Domain-сущности **не обязаны** иметь прямое соответствие таблицам.

Допускаются:

- вспомогательные таблицы;
- технические таблицы;
- таблицы агрегатов;
- служебные таблицы (включая таблицы версии схемы).

---

## Идентификаторы и ключи

Стратегия идентификаторов определяется **на уровне конкретных таблиц**, а не нормативно для всей схемы.

Допускается использование:

- внутреннего числового идентификатора (`bigint / serial`);
- внешнего стабильного идентификатора (`uuid`);
- генерации идентификаторов:
  - на стороне приложения,
  - на стороне БД,
  - либо в смешанном режиме.

Схема обязана явно указывать:

- какие колонки являются идентификаторами;
- какие из них используются как первичные ключи;
- какие предназначены для внешнего использования.

---

## Связи и ограничения

Использование **внешних ключей (foreign keys)** является обязательным.

Требования:

- все логические связи между таблицами должны быть выражены через FK;
- внешние ключи используются максимально полно для связанных сущностей;
- ограничения целостности не заменяются логикой приложения.

Все ограничения должны быть описаны декларативно, включая:

- UNIQUE;
- NOT NULL;
- CHECK constraints;
- правила ссылочной целостности.

---

## Индексы

Индексы являются **обязательной частью декларативной схемы**.

Требования:

- все индексы должны быть описаны явно;
- индексы, относящиеся к таблице, описываются в декларации этой таблицы;
- отсутствие индекса в декларации означает его отсутствие в допустимой схеме.

---

## Версионирование схемы

Схема данных в MVP имеет **явную версию**.

Требования:

- версия схемы фиксируется декларативно;
- версия схемы также хранится в базе данных в отдельной служебной таблице;
- DB-слой использует версию схемы для контроля состояния базы данных.

Форма хранения версии определяется декларацией схемы.

---

## Recreate / preserve semantics

DB-слой обязан поддерживать пересоздание схемы с сохранением данных.

Нормативные положения:

- данные, отсутствующие в новой версии схемы, при восстановлении **отбрасываются**;
- восстановление данных ограничено структурами, присутствующими в декларации;
- порядок операций recreate-with-preserve не описывается в декларации схемы и относится к ответственности DB-слоя.

---

## СУБД-независимость

Декларативная схема обязана использовать **только portable-конструкции**, поддерживаемые `knex`.

Запрещено:

- использование СУБД-специфичных расширений;
- условные ветки под конкретные СУБД;
- декларации, зависящие от runtime-окружения.

Схема должна быть применима к любой СУБД, поддерживаемой `knex`.

---

## Минимальный пример формы декларации

Пример иллюстрирует **форму**, а не нормативную структуру конкретной таблицы.

```json
{
  "tables": {
    "example_table": {
      "columns": {
        "id": { "type": "bigint", "primary": true },
        "uuid": { "type": "uuid", "unique": true, "notNull": true },
        "created_at": { "type": "timestamp", "notNull": true }
      },
      "foreignKeys": [],
      "indexes": [{ "columns": ["uuid"], "unique": true }]
    }
  },
  "schemaVersion": 1
}
```

---

## Границы документа

Документ не описывает:

- конкретные таблицы Mindstream;
- имена реальных сущностей;
- SQL-реализацию;
- API DB-слоя;
- порядок применения схемы;
- CLI-команды.

Эти вопросы описываются в последующих документах уровня `code/storage/`.

---

## Итог

`schema.md` фиксирует декларативную, воспроизводимую и СУБД-независимую форму описания схемы данных DB-слоя MVP Mindstream, обеспечивая агентам и коду единую нормативную основу для управления структурой хранения.
