# DI Compatibility — @teqfw/di

Path: `./ctx/docs/code/di-compatibility.md`

## Назначение

Документ фиксирует **жёсткие инженерные инварианты организации кода**, необходимые для признания кодовой базы **совместимой с DI-моделью `@teqfw/di`** в рамках проекта Mindstream.

Документ носит **нормативный характер**. Любое отклонение от зафиксированных положений считается дефектом кодовой базы.

Документ не является руководством по использованию `@teqfw/di` и не дублирует README библиотеки.

---

## Роль DI в кодовом слое

В проекте Mindstream:

- `@teqfw/di` является **единственным допустимым механизмом связывания project-кода**;
- DI используется как базовая форма композиции кода, а не как вспомогательный инструмент;
- все зависимости между модулями выражаются **исключительно декларативно**, через DI-контейнер.

Код, обходящий DI-модель, **не считается частью корректной кодовой базы проекта**.

---

## Пространства имён и зоны кода

В проекте зафиксирован **строго ограниченный набор корневых namespace**:

- `Mindstream_Back_`
- `Mindstream_Shared_`
- `Mindstream_Web_`

Использование иных корневых namespace в MVP **не допускается**.

### Семантика зон

- `Back` — серверная логика и backend-службы.
- `Web` — клиентская логика и фронтенд-исполнение.
- `Shared` — platform-agnostic код, пригодный для исполнения как на фронте, так и на бэке.

`Mindstream_Shared_`:

- не имеет доступа к platform API;
- не использует `node:*`, DOM, `fetch`, `process` и аналогичные зависимости;
- содержит DTO, утилиты и чистую бизнес-логику.

---

## Импорт и связывание кода

### Запрещено

В любом бизнес-модуле **запрещено**:

- статически импортировать project-код;
- использовать относительные импорты вида `../X.js`;
- напрямую импортировать platform API;
- напрямую импортировать сторонние библиотеки.

### Допустимо

- Все зависимости объявляются **исключительно через DI**;
- доступ к platform API и сторонним библиотекам осуществляется **только как dependency IDs**.

Нарушение любого из этих правил считается архитектурным дефектом.

---

## Composition Root

### Количество и роль

В проекте зафиксированы следующие production composition root:

- один для `Back`;
- один для `Web`;
- один для Service Worker.

Тесты используют **отдельный composition root**, который может создаваться:

- для тестового набора;
- либо для каждого unit-теста отдельно.

### Полномочия composition root

Только composition root имеет право:

- использовать статические импорты project-кода;
- конфигурировать namespace resolver;
- определять соответствие namespace ↔ filesystem;
- подключать platform- и сторонние зависимости.

Любая логика конфигурации DI вне composition root **запрещена**.

---

## Dependency ID Model

### Обязательные соглашения

Использование суффиксов `$` / `$$` является **обязательным**:

- `$` — singleton, создаваемый из default export;
- `$$` — новый экземпляр, создаваемый из default export;
- отсутствие суффикса — raw module / export без создания экземпляра.

Нарушение соглашения трактуется как дефект.

### Экспорты

- **Нормативная форма** модуля — `default export` (class или factory).
- Использование `.export` допускается, но не является базовым путём.
- Использование `(factory)` и `(proxy)` считается advanced-возможностью и не входит в базовый набор.

---

## Platform Dependencies

- Dependency IDs с префиксом `node:` допустимы **только в `Mindstream_Back_`**.
- `Web` и `Shared` не используют platform-specific dependency IDs.
- Любой доступ к платформе осуществляется только через DI.

---

## Форма модулей

- Default export является нормативной формой.
- Модули без default export допускаются только в исключительных случаях и по явному решению.
- Наличие top-level логики в ES-модуле допустимо и не считается нарушением.

---

## Test Mode

### Назначение

`enableTestMode()` определяет **разрешённость вмешательства в DI-граф**, а не сам факт тестирования.

### Нормативные требования

В проекте Mindstream:

- все unit-тесты выполняются:
  - через DI-контейнер;
  - в test mode;
- test mode обязателен для:
  - регистрации зависимостей через `register`;
  - переопределения production-зависимостей;
  - мокирования platform dependencies, включая `node:*`.

### Мокирование

В unit-тестах допускается:

- регистрация зависимостей, отсутствующих в production namespace;
- свободное переопределение любых зависимостей.

---

## Статус и критерий совместимости

Положения данного документа являются **жёсткими инженерными инвариантами**.

Код считается **совместимым с `@teqfw/di` в рамках проекта Mindstream** только при одновременном соблюдении всех зафиксированных требований.

Любое нарушение:

- фиксируется как дефект;
- не трактуется как стиль, рекомендация или технический долг.
