# Code Conventions — MVP

Path: `./ctx/docs/code/conventions.md`

## Назначение

Документ фиксирует **инженерные конвенции кода MVP Mindstream**.  
Он определяет допустимые языки, формы организации кода, модели исполнения и инженерные инварианты, обязательные для всей кодовой базы MVP.

Документ не описывает архитектуру системы, продуктовые свойства и пользовательский интерфейс.

---

## Язык и диалект

- Основной язык кода — **JavaScript**.
- Серверный и клиентский код пишутся на JavaScript.
- Иные форматы допускаются только в статусе:
  - декларативной конфигурации;
  - инфраструктурных скриптов.
- Исполняемым кодом продукта считается только JavaScript.
- Собственный код проекта использует философию **Tequila Framework**:
  - внедрение зависимостей через конструктор;
  - использование `@teqfw/di` как DI-контейнера.
- Статические импорты допускаются только в composition root.
- В остальном коде зависимости разрешаются через DI и динамический импорт контейнера.
- CommonJS допускается только внутри сторонних зависимостей.

---

## Среда исполнения кода

- Код может быть **shared** и использоваться как на сервере, так и в браузере.
- Допускается код, предназначенный исключительно для Node.js или исключительно для браузера.
- Разделение ролей server / client не влияет на модель внедрения зависимостей.
- Условная логика по runtime и feature detection **допускается**.

---

## Конфигурация окружения

- Конфигурация окружения читается из переменных среды (`process.env`).
- Поддержка файлов `.env` реализуется **нативно**, средствами платформы (например, через `fs`), без использования сторонних библиотек.
- Загрузка `.env` выполняется явно в **composition root** (точке входа приложения или CLI).
- Значения из `.env` не должны перезаписывать уже заданные переменные окружения.
- Использование пакетов типа `dotenv`, `env` и аналогичных **не допускается по умолчанию** и требует явного согласования с человеком.
- `process.env` рассматривается как допустимая форма глобального состояния, предоставляемого платформой.

---

## Зависимости и импорт

- Использование сторонних библиотек допускается только при явном согласовании с человеком.
- Предпочтение отдаётся нативным возможностям платформы.
- Запрещены:
  - крупные фреймворки;
  - кодогенерация;
  - декораторы.
- В качестве DI-контейнера используется только `@teqfw/di`.
- Прямая работа с API платформы (DOM, Fetch, fs, process и т.п.) допускается без абстракций.
- Добавление зависимостей, дублирующих стандартные возможности платформы, считается нежелательным и требует обоснования.

---

## Асинхронность и управление выполнением

- Асинхронность является базовым режимом исполнения (`async/await`).
- Допускаются:
  - callbacks, включая публичные контракты;
  - event emitters;
  - реактивные абстракции (streams, observables).
- Допускается фоновое выполнение (timers, workers).

---

## Состояние и мутабельность

- Мутабельное состояние допускается, но считается нежелательным.
- Приоритет отдаётся функциональному стилю.
- Следует максимально придерживаться:
  - иммутабельности данных;
  - однонаправленного изменения состояния.
- Глобальное состояние допускается только в форме,
  предоставляемой платформой (`process`, `window`).
- Пользовательское глобальное состояние должно избегаться.

---

## Ошибки и сбои

- Ошибки трактуются как **факты наблюдения**.
- Ошибки подлежат обязательному логированию.
- После фиксации ошибки код не должен приводить к падению приложения.
- Подавление ошибок допускается после логирования.

---

## Формат и структура кода

- Имена модулей и классов соответствуют правилам Tequila Framework.
- Корневой namespace проекта указывается явно.
- Жёсткие ограничения на длину модулей не заданы;
  рекомендуется удерживаться в пределах до трёх экранов.
- «Быстрый код» без структуры **не допускается**, включая MVP.
- Дублирование кода допускается как временная мера.

---

## Тестирование

- Для MVP достаточно **unit-тестов**.
- Интеграционные тесты допускаются по необходимости.
- Отсутствие тестов допускается только для:
  - точек входа приложения;
  - стабильных интерфейсов, не подверженных изменениям.

---

## Запрещённое

- **TypeScript** запрещён.
- `eval` запрещён.
- Динамические импорты допускаются только через DI-контейнер (`@teqfw/di`).
- Reflection-подобные техники запрещены.

---

## Роль конвенций

- Конвенции задают минимальные инженерные рамки.
- Отклонения от конвенций допускаются.
- Нарушение конвенций считается **техническим долгом**.
- Технический долг подлежит фиксации в отчёте агента по итерации.
