# Web Server Runtime

Path: `ctx/docs/environment/runtime/web-server.md`

## Назначение документа

Документ фиксирует контракт и границы ответственности HTTP-сервера в приложении **Mindstream** на уровне runtime. Документ является нормативным контекстом и используется при разработке и интеграции инфраструктурных компонентов.

Данный документ не описывает доменную или прикладную логику приложения.

---

## Статус HTTP-сервера

HTTP-сервер в Mindstream является **инфраструктурным transport-слоем**.

Для реализации сервера используется пакет `@flancer32/teq-web`, который:

- не является частью доменной модели;
- не участвует в композиции прикладных подсистем;
- предоставляет только механизм приёма HTTP-запросов и диспетчеризации обработчиков.

Сервер рассматривается как постоянная инфраструктурная зависимость проекта, при этом архитектурно остаётся заменяемым компонентом.

---

## Модель запуска приложения

Mindstream является CLI-запускаемым backend-приложением.

Переход приложения в режим работы веб-сервера осуществляется **явной CLI-командой**:

```
runtime:web
```

Только при выполнении этой команды:

- инициализируется HTTP-сервер;
- регистрируются HTTP-обработчики приложения;
- процесс переходит в long-running режим.

В остальных режимах запуска HTTP-сервер отсутствует.

---

## Экземплярность и масштабирование

В рамках одного процесса приложения:

- существует **ровно один HTTP-сервер**;
- повторная инициализация сервера недопустима.

Горизонтальное масштабирование осуществляется **внешними средствами** (PM2) путём запуска нескольких процессов. Каждый процесс содержит собственный экземпляр HTTP-сервера.

---

## Lifecycle сервера

HTTP-сервер:

- запускается при выполнении команды `runtime:web`;
- живёт на протяжении всего жизненного цикла процесса;
- не управляет завершением процесса самостоятельно.

Приложение может:

- подписываться на сигналы завершения процесса;
- вызывать методы сервера или HTTP-обработчиков для корректного освобождения ресурсов.

Требования к graceful shutdown определяются на уровне приложения и обработчиков, а не на уровне сервера как инфраструктурного компонента.

---

## Конфигурация

Конфигурация HTTP-сервера является частью **общего конфигурационного объекта приложения**.

Сервер получает параметры (порт, режим работы и прочие runtime-настройки) исключительно через этот объект. Отдельной конфигурации сервера не существует.

---

## TLS и сетевое окружение

TLS-терминация осуществляется **внешним reverse-proxy (apache)**.

HTTP-сервер Mindstream:

- работает за reverse-proxy;
- не обслуживает TLS напрямую;
- предполагает наличие TLS во всех окружениях, включая dev.

---

## Тип обслуживаемого API

HTTP-сервер обслуживает исключительно **backend JSON API**.

- Модель взаимодействия: REST-подобные HTTP-запросы (GET / POST).
- Формат ответов: JSON.
- Обслуживание HTML, SPA или статических файлов сервером Mindstream **запрещено**.

---

## Статус HTTP-обработчиков

HTTP-обработчики:

- принадлежат приложению Mindstream;
- регистрируются в сервере через инфраструктурный механизм `@flancer32/teq-web`;
- являются адаптерами между HTTP-запросами и внутренними операциями приложения.

HTTP-обработчики могут:

- вызывать прикладные и доменные операции;
- сериализовать результаты выполнения;
- участвовать в управлении завершением приложения.

Контракт и правила реализации HTTP-обработчиков фиксируются в документах уровня composition.

---

## Границы ответственности документа

Данный документ **не описывает**:

- доменные операции;
- структуру API-эндпоинтов;
- бизнес-логику приложения;
- формат DTO;
- поведение конкретных HTTP-обработчиков.

Все перечисленные аспекты фиксируются в документах более высокого уровня абстракции.
