# Attention Storage Invariants

Path: `ctx/docs/architecture/storage/attention-storage-invariants.md`

## Назначение

Документ фиксирует **инварианты хранилища** для подсистемы сигналов внимания в MVP Mindstream.

Инварианты определяют, какие состояния **обязаны быть истинны в storage** независимо от конкретной СУБД, схемы таблиц, SQL, индексов и реализации сервисов.

Документ относится только к storage-контуру сигналов внимания и не описывает ingress, API, UI, алгоритмы агрегации и любые вычислительные процессы.

---

## Роль storage в архитектуре (MVP)

Storage в контуре сигналов внимания является **enforcement layer** и:

- фиксирует принятые статистические данные в устойчивом виде;
- обеспечивает целостность и дедупликацию на уровне данных;
- не содержит доменной логики, кроме enforce инвариантов;
- не инициирует реактивных процессов;
- не формирует read-модели для anonymous identity.

---

## Логические сущности storage (MVP)

В рамках MVP в storage контура сигналов внимания допускаются только следующие логические сущности:

1. **Anonymous Identity**
2. **Publication Reference**
3. **Attention Event (State)**

Иные сущности, включая вспомогательные (profiles, sessions, counters, aggregates), в MVP для данного контура не вводятся.

---

## Invariants: Anonymous Identity

### Источник identity

- Anonymous identity представлена UUID стандартного формата.
- UUID генерируется исключительно на фронте и регистрируется на сервере явным образом.
- Storage не является источником identity и не генерирует UUID.

### Наличие и регистрация

- Любое событие внимания допускается к фиксации только при наличии зарегистрированной identity.
- Identity может существовать в storage независимо от наличия событий внимания.

### Метаданные identity

- Storage обязан фиксировать **время регистрации identity** (UTC).

### Удаление identity

- Identity без событий внимания подлежит удалению по TTL.
- Удаление identity является полным и необратимым.
- Tombstone-механизм или сохранение следов удаления identity в MVP не используется.

---

## Invariants: Publication Reference

### Обязательность существования публикации

- Attention Event может ссылаться только на публикацию, которая существует в storage корпусных данных.
- Попытка зафиксировать событие внимания для несуществующей публикации является ошибкой.

### Удаление публикации

- Если публикация удаляется из корпуса, связанные с ней данные attention должны быть удалены каскадно.
- После каскадного удаления публикации не остаётся attention-состояний, ссылающихся на неё.

---

## Invariants: Attention Event (State)

### Онтология события

Attention Event в MVP является не историческим событием, а **логическим состоянием внимания**:

- состояние фиксирует, что для пары (identity, publication) внимание данного типа считается проявленным;
- storage не хранит историю повторов одного и того же события внимания.

### Уникальность состояния

- Для каждой тройки `(anonymous_identity, publication_id, attention_type)` допускается не более одного внимания-состояния.
- В storage не допускается наличие дублей, нарушающих уникальность состояния.

### Повторная отправка (dedup semantics)

- Повторная отправка одинакового события внимания должна быть **полностью игнорируема** на уровне устойчивого состояния.
- Повторная отправка не должна:
  - создавать новые записи;
  - обновлять timestamp;
  - изменять любое производное состояние.

### Timestamp

- Timestamp, связанный с attention-состоянием, трактуется как **момент первичной фиксации** этого состояния (UTC).
- Timestamp не обновляется при повторных отправках.

---

## Deduplication invariants

- Дедупликация является инвариантом хранения, а не ingress-логики.
- Storage обязан обеспечивать невозможность существования дубликатов attention-состояний.
- Storage не обязан предотвращать поступление дублей на вход backend, но обязан обеспечивать, что дубли не приводят к изменению устойчивого состояния.

---

## Retention and cleanup

### Очистка identity без событий

- TTL-очистка identities без событий допускается.
- Механизм очистки может выполняться вручную и не является обязательным процессом runtime-контура.

### Очистка устаревших attention-данных

- Удаление attention-данных старше заданного срока (например, 1 год) допускается.
- Очистка может быть реализована как отдельный запуск вручную и не является обязательным процессом runtime-контура.

### Сохранение агрегированной статистики при очистке

- При очистке первичных attention-состояний допускается сохранение агрегированной статистики.
- В MVP агрегаты не являются обязательной частью storage, но их появление допускается при условии, что они не нарушают остальные инварианты данного документа.

---

## Derived data (future-compatible boundary)

В будущем допускается появление:

- server-side агрегатов;
- derived tables;
- materialized views;

если выполняются условия:

- они не меняют онтологию первичных attention-состояний;
- они не вводят read-модели для identity в рамках write-ingress контура;
- они не нарушают enforce инварианты uniqueness, existence и cascade cleanup.

---

## Связанные документы

- `ctx/docs/architecture/anonymous-identity.md`
- `ctx/docs/architecture/ingress/http-ingress.md`
- `ctx/docs/architecture/ingress/attention-write-ingress.md`
- `ctx/docs/architecture/data-flow/attention.md`
- `ctx/docs/architecture/attention/interest-vector.md`

---

## Итог

Storage-конур сигналов внимания в MVP хранит:

- зарегистрированные anonymous identities (с временем регистрации);
- ссылки на публикации, существующие в корпусе (как внешнюю зависимость);
- attention-состояния (не историю), уникальные по `(identity, publication, attention_type)`, полностью идемпотентные к повторной отправке и удаляемые каскадно при удалении публикации.

Очистка данных допускается и может выполняться вручную. Derived data допускаются в будущем при соблюдении инвариантов данного документа.
