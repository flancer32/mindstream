# Attention Storage Data Model

Path: `./ctx/docs/architecture/storage/attention-storage-model.md`

## Назначение

Документ фиксирует **структурную модель данных** для хранения статистики внимания в MVP Mindstream.

Модель предназначена для:

- формулировки задач агентам на создание схемы БД;
- обеспечения enforce инвариантов, зафиксированных в архитектурных документах;
- однозначного отображения логических сущностей storage в реляционную схему.

Документ не описывает SQL, миграции, ORM, индексы производительности и способы доступа к данным.

---

## Целевая модель хранения

- Тип хранилища: **реляционное**
- Целевая СУБД: **PostgreSQL (совместимая схема)**

---

## Логические сущности и атрибуты

### 1. Anonymous Identity

Anonymous identity представляет зарегистрированный анонимный идентификатор браузерного контекста.

**Атрибуты:**

- `identity_id`
  - тип: UUID
  - обязательный
  - первичный ключ
- `registered_at`
  - тип: timestamp (UTC)
  - обязательный
  - фиксирует момент регистрации identity

**Инварианты:**

- identity может существовать без событий внимания;
- identity без событий может быть удалена по TTL;
- identity удаляется полностью и необратимо;
- storage не генерирует identity.

---

### 2. Publication Reference

Publication Reference представляет ссылку на публикацию, существующую в Content Collection.

**Атрибуты:**

- `publication_id`
  - тип: определяется Content Collection
  - обязательный
  - первичный ключ
  - внешний ключ на таблицу публикаций

**Инварианты:**

- attention-событие может ссылаться только на существующую публикацию;
- попытка записи события для несуществующей публикации является ошибкой;
- удаление публикации приводит к каскадному удалению связанных attention-данных.

---

### 3. Attention Event (State)

Attention Event представляет **логическое состояние внимания**, а не историческое событие.

Состояние фиксирует факт того, что attention данного типа считается проявленным для пары `(identity, publication)`.

**Атрибуты:**

- `identity_id`
  - тип: UUID
  - обязательный
  - внешний ключ → Anonymous Identity
- `publication_id`
  - тип: соответствует Publication Reference
  - обязательный
  - внешний ключ → Publication Reference
- `attention_type`
  - тип: enum (см. ниже)
  - обязательный
- `created_at`
  - тип: timestamp (UTC)
  - обязательный
  - фиксирует момент первичной фиксации состояния

**Ключи и ограничения:**

- составной уникальный ключ:

```
(identity_id, publication_id, attention_type)
```

**Инварианты:**

- для одной тройки `(identity, publication, attention_type)` допускается не более одного состояния;
- повторная запись такого же события полностью игнорируется;
- `created_at` не обновляется при повторной отправке;
- история повторов не хранится.

---

## Attention Type Enum

Перечень допустимых типов сигналов внимания **закрыт** в рамках MVP.

Допустимые значения:

- `overview_view`  
  Факт открытия обзора публикации.
- `link_click`  
  Факт перехода по ссылке на источник публикации.
- `link_click_after_overview`  
  Факт перехода по ссылке после предварительного просмотра обзора.

Расширение перечня attention-type требует пересмотра архитектурного набора документации.

---

## Constraint Invariants (summary)

Storage обязан enforce следующие ограничения:

1. **Existence**

- attention-событие невозможно без существующей identity;
- attention-событие невозможно без существующей публикации.

2. **Uniqueness**

- уникальность `(identity_id, publication_id, attention_type)`.

3. **Referential integrity**

- каскадное удаление attention-событий при удалении публикации;
- каскадное удаление attention-событий при удалении identity.

4. **Immutability**

- attention-состояние не изменяется после первичной фиксации.

---

## Retention and cleanup (storage-level expectations)

- схема должна позволять:
- удаление identity без событий;
- удаление attention-событий старше заданного срока;
- очистка может выполняться вручную;
- при очистке attention-событий допускается сохранение агрегированной статистики вне первичных таблиц.

---

## Примеры write-событий (conceptual)

Пример входных данных для write-ingress (формат не нормативный, приведён для контекста):

```json
{
  "identity_id": "550e8400-e29b-41d4-a716-446655440000",
  "publication_id": "pub_12345",
  "attention_type": "overview_view",
  "timestamp": "2026-02-10T15:30:00Z"
}
```

---

## Границы документа

Документ:

- не определяет SQL DDL;
- не описывает индексы оптимизации;
- не вводит агрегатные таблицы;
- не описывает ORM-модели;
- не задаёт API-контракты.

Все перечисленные вопросы относятся к уровню реализации и формулируются в задачах агентам.

---

## Связанные документы

- `ctx/docs/architecture/anonymous-identity/invariants.md`
- `ctx/docs/architecture/ingress/attention-write-ingress.md`
- `ctx/docs/architecture/data-flow/attention.md`
- `ctx/docs/architecture/attention/storage-invariants.md`

---

## Итог

Данный документ задаёт **полную и однозначную структурную модель данных** для хранения статистики внимания в MVP Mindstream и предназначен для прямого использования при постановке задачи codex-агенту на генерацию схемы БД.
