# Extraction Workflow in Ingestion Pipeline

Path: `ctx/docs/architecture/ingestion/extraction-workflow.md`

## 1. Назначение документа

Данный документ описывает workflow извлечения md-текста публикаций во входном контуре (Ingestion) системы Mindstream на уровне архитектуры MVP.

Документ фиксирует:

- место шага извлечения текста в общем ingestion-процессе;
- статусную модель публикации в контексте извлечения текста;
- правила отбора публикаций для обработки;
- порядок и гранулярность выполнения обработки;
- классы ошибок и их влияние на дальнейший workflow.

Документ не описывает:

- алгоритмы извлечения текста;
- правила парсинга HTML;
- структуру данных и схемы хранения;
- реализационные детали команд и кода.

## 2. Место шага извлечения в ingestion

Извлечение md-текста публикации является продолжением ingestion после этапа discovery и относится к тому же входному контуру.

Ingestion для источника Habr в MVP концептуально разделён на две последовательные фазы:

- discovery: обнаружение и регистрация публикаций на основе RSS;
- extraction: получение HTML публикации и извлечение md-текста.

Обе фазы направлены на получение внешних данных, пригодных для последующей обработки, и не относятся к processing-контуру.

## 3. Командная модель

Извлечение md-текста выполняется специализированной source-specific командой:

- `ingest:extract:habr`

Команда:

- не принимает входных параметров;
- работает строго по внутренним правилам MVP;
- запрещена к параллельному запуску архитектурно;
- может запускаться повторно без нарушения идемпотентности ingestion.

Команда не инициирует последующие этапы обработки публикации.

## 4. Статусная модель публикации

Каждая публикация в системе имеет состояние, определяющее её участие в workflow извлечения md-текста.

На уровне архитектуры различаются следующие логические состояния:

- публикация зарегистрирована, но извлечение md-текста не выполнялось;
- публикация успешно обработана, md-текст извлечён;
- публикация временно не обработана из-за сетевой ошибки или недоступности HTML;
- публикация обработана, но признана битой из-за невозможности извлечения md-текста.

Статус публикации является единственным источником истины при выборе публикаций для обработки.

## 4.1 Кодовые значения статусов

В кодовой базе статусы фиксируются как справочник и имеют следующие значения.

- `extract_pending` — публикация зарегистрирована и ожидает извлечения md-текста;
- `extracted` — md-текст успешно извлечён;
- `extract_failed` — временная ошибка извлечения, допускающая повторную обработку;
- `extract_broken` — публикация признана битой из-за невозможности извлечения md-текста.

## 5. Выбор публикаций для обработки

Команда извлечения md-текста:

- выбирает публикации исключительно по их статусу;
- не ориентируется на дату discovery или время регистрации;
- не обрабатывает публикации, уже успешно прошедшие этап извлечения;
- пропускает публикации, помеченные как битые.

Повторная обработка публикации возможна только при явном ручном изменении её статуса.

## 6. Гранулярность и пакетная обработка

Единицей обработки является одна публикация.

Пакетная обработка используется исключительно для ограничения нагрузки на внешний источник и не является транзакционной единицей.

Архитектурные правила пакетной обработки:

- размер пакета фиксирован и задан в коде;
- публикации внутри пакета обрабатываются строго последовательно;
- успешность пакета как целого не отслеживается;
- результат обработки фиксируется отдельно для каждой публикации.

Между пакетами применяется искусственная пауза, заданная в коде, для снижения нагрузки на источник.

## 7. Работа с HTML публикации

Для каждой публикации workflow извлечения включает работу с HTML-представлением публикации.

Архитектурные правила:

- HTML может быть загружен из внешнего источника или использован из временного хранилища;
- если сохранённый HTML существует и срок его жизни не истёк, повторный сетевой запрос не выполняется;
- HTML сохраняется во временном хранилище с ограниченным сроком жизни;
- HTML не является каноническим артефактом публикации.

HTML используется как вход для этапа извлечения md-текста и не передаётся в последующие контуры обработки.

## 8. Классы ошибок и их влияние на workflow

В рамках extraction-workflow различаются принципиально разные классы ошибок.

Сетевые ошибки:

- временная недоступность источника;
- HTTP-статусы ошибок;
- редиректы.

При сетевых ошибках публикация помечается как временно не обработанная и может быть повторно обработана при следующем запуске команды.

Структурные ошибки:

- HTML получен и сохранён;
- структура HTML не позволяет извлечь полный md-текст публикации.

При структурных ошибках публикация помечается как битая и исключается из дальнейшего workflow до ручного вмешательства.

## 9. Результат шага извлечения

Результатом extraction-workflow считается наличие md-текста публикации.

Md-текст:

- хранится в отдельной сущности, отражающей этап извлечения текста;
- не является каноническим артефактом публикации;
- используется как вход для последующих этапов обработки.

Завершение extraction-workflow не инициирует автоматически следующий этап обработки публикации.

## 10. Связь с другими документами

Настоящий документ дополняет, но не заменяет другие архитектурные документы ingestion-контура.

Инварианты идентификации публикаций и источников фиксируются в документе `sources-and-identity.md`.

Инварианты операции извлечения текста фиксируются в документе `text-extraction.md`.

Любые изменения workflow извлечения md-текста не должны противоречить положениям указанных документов.

## 11. Ограничения документа

Настоящий документ:

- описывает workflow и статусную модель на архитектурном уровне;
- не содержит псевдокода, диаграмм и таблиц;
- не фиксирует структуру БД и формат полей;
- не описывает реализацию команд и их внутреннюю логику.

Документ предназначен для использования как когнитивный контекст при разработке ingestion-контура MVP Mindstream и для координации агентной разработки.
