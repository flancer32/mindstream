# Sources and Identity (Ingestion, MVP)

Path: `ctx/docs/architecture/ingestion/sources-and-identity.md`

Документ фиксирует каноническую модель источников публикаций и идентификации публикаций в ingestion-контуре Mindstream на уровне архитектуры MVP и задаёт инварианты, обязательные для схемы данных, ingestion-кода и последующих контуров обработки.

Документ является нормативным. Любые изменения, противоречащие зафиксированным здесь положениям, считаются архитектурным дефектом.

---

## 1. Статус источника (`Source`) в системе

В рамках MVP Mindstream источник публикаций (`Source`) рассматривается как минимальный идентификатор внешнего источника и связанный с ним провайдер доступа и идентификации, а не как наблюдаемая или управляемая сущность.

`Source` не моделируется как объект с жизненным циклом, историей или состоянием и не является частью продуктовых данных.

---

## 2. Онтологический статус `Source`

`Source` в MVP:

- задаёт пространство идентификации публикаций;
- определяет, какой провайдер доступа к внешнему источнику используется в коде;
- определяет правила discovery и идентификации публикаций;
- участвует в формировании корпуса публикаций и персональных лент как признак происхождения публикации.

`Source` в MVP не:

- имеет собственного состояния или истории;
- наблюдается системой как динамический объект;
- управляется или конфигурируется во время выполнения;
- участвует в продуктовой или пользовательской логике напрямую.

---

## 3. Гранулярность источников

Каждая внешняя платформа рассматривается как один источник.

Для MVP:

- Habr — один `Source`;
- другие платформы (Medium, arXiv и т.п.) — отдельные `Source`.

Внутренние подразделения платформ (RSS-ленты, рубрики, хабы, категории, теги) не имеют онтологического статуса источников и не моделируются в системе.

---

## 4. `source_id`

`source_id` — стабильный и заранее определённый идентификатор источника.

Свойства `source_id`:

- уникален в пределах системы;
- неизменяем;
- не имеет версии;
- не создаётся динамически ingestion-процессом;
- однозначно определяет провайдер доступа к источнику в коде.

Каждый провайдер доступа жёстко привязан к своему `source_id` и хардкодит правила discovery, идентификации и fetch для данного источника.

---

## 5. Каноническая идентификация публикации

Каждая публикация в системе однозначно идентифицируется парой:

```

(source_id, source_item_hash)

```

Эта пара является единственным каноническим ключом публикации во всех контурах системы.

Никакие другие поля (URL, заголовок, даты, GUID и т.п.) не считаются идентификаторами публикации.

---

## 6. `source_item_hash`

`source_item_hash` — результат детерминированной source-specific функции идентификации.

Для MVP (Habr):

- входом функции идентификации является URL публикации;
- `source_item_hash` вычисляется как хэш от URL;
- URL используется только как вход в функцию идентификации и не является каноническим ключом сам по себе.

`source_item_hash` является opaque-значением вне контекста соответствующего `source_id` и не предполагает универсального смысла между источниками.

---

## 7. Идемпотентность ingestion

Идемпотентность ingestion обеспечивается исключительно через канонический ключ `(source_id, source_item_hash)`.

Правила:

- повторное обнаружение публикации с тем же каноническим ключом не создаёт новую сущность;
- повторный fetch публикации с тем же каноническим ключом запрещён логикой ingestion;
- ingestion допускает многократные повторные запуски без изменения итогового состояния данных.

---

## 8. Иммутабельность публикаций

Публикация считается иммутабельной после первого успешного fetch.

Следствия:

- изменения текста, заголовка или метаданных источником не отслеживаются;
- повторная загрузка для обновления данных не выполняется;
- версии публикаций не моделируются.

---

## 9. Исчезновение публикаций

Исчезновение публикации из RSS или внешнего источника не моделируется в рамках MVP.

Публикации, попавшие в корпус, остаются в нём навсегда и продолжают участвовать в формировании персональных лент независимо от дальнейшей доступности источника.

---

## 10. Роль RSS в MVP

RSS используется исключительно как discovery-механизм.

RSS:

- предоставляет ссылки на публикации;
- не используется как источник текста;
- не используется как fallback для контента;
- не имеет самостоятельного статуса в системе.

---

## 11. Связь ingestion и processing

Ingestion:

- фиксирует факт готовности публикации к дальнейшей обработке;
- не инициирует processing;
- не принимает решений о дальнейшей судьбе публикации.

Processing-контур автономен и принимает решения, опираясь только на зафиксированное состояние данных.

---

## 12. Явные запреты

В рамках MVP запрещено:

- моделировать `Source` как наблюдаемую или управляемую сущность;
- хранить историю или состояние источников;
- использовать URL как канонический ключ публикации;
- переобрабатывать публикации с тем же каноническим ключом;
- моделировать исчезновение или удаление публикаций;
- использовать RSS-контент как текст публикации;
- связывать ingestion с бизнес-логикой processing.

---

## 13. Статус документа

Документ фиксирует архитектурные инварианты ingestion-контура MVP и обязателен для соблюдения всеми последующими слоями системы.
