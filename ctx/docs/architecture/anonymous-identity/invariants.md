# Anonymous Identity

Path: `./ctx/docs/architecture/anonymous-identity/invariants.md`

## Назначение

Данный документ фиксирует архитектурную модель **anonymous identity** — анонимного идентификатора, используемого в Mindstream как якорь для сбора и агрегации статистики внимания. Документ определяет инварианты регистрации identity, допустимые операции с ней и границы её жизненного цикла в рамках MVP.

Anonymous identity не является пользователем, субъектом, профилем или участником взаимодействия с системой. Она существует исключительно как технический идентификатор источника статистических сигналов.

## Понятие Anonymous Identity

Anonymous identity — это:

- пассивный идентификатор;
- представленный UUID стандартного формата;
- генерируемый исключительно на стороне фронта;
- связанный с одним профилем браузера.

Anonymous identity:

- не имеет аутентификации;
- не имеет прав доступа;
- не имеет пользовательского состояния;
- не используется для персонализации ответов системы.

Использование термина «user» к данной сущности не допускается.

## Регистрация Identity

Регистрация anonymous identity является **явным архитектурным событием**.

Инварианты регистрации:

- UUID должен быть зарегистрирован на сервере до приёма любых событий внимания.
- События, поступившие без зарегистрированной identity, считаются недопустимыми и не принимаются.
- Имплицитная регистрация identity через первое событие запрещена.
- Повторная регистрация существующего UUID считается идемпотентной и не изменяет состояние системы.

Регистрация identity фиксирует только факт существования UUID и не влечёт создания дополнительных данных.

## Использование Identity в write-path

Anonymous identity используется исключительно в write-path для:

- связывания событий внимания;
- дедупликации событий;
- последующей серверной агрегации.

Все события внимания обязаны:

- содержать UUID зарегистрированной identity;
- ссылаться на конкретную публикацию;
- иметь фиксированный тип события;
- содержать timestamp в UTC.

Read-доступ к данным, связанным с identity, в рамках MVP отсутствует.

## Дедупликация и целостность

Для одной anonymous identity допускается не более одного события одного типа для одной публикации.

Повторная отправка идентичных событий допустима, но не должна приводить к изменению агрегированного состояния. Обеспечение идемпотентности является инвариантом хранения данных.

## Lifecycle Identity

Lifecycle anonymous identity включает следующие состояния:

1. Отсутствие identity — UUID не сгенерирован или удалён на фронте.
2. Зарегистрированная identity без событий.
3. Зарегистрированная identity с событиями внимания.

Anonymous identity без связанных событий подлежит удалению по TTL. Удаление identity приводит к утрате доступа к ранее накопленным данным и не предусматривает восстановления.

## Ограничения и запреты

В рамках MVP запрещено:

- использовать anonymous identity для персонализации;
- связывать identity с IP-адресами или user-agent;
- вводить read-API для identity;
- трактовать identity как пользователя;
- хранить любые персональные данные.

Любое расширение роли anonymous identity за пределы описанных инвариантов считается выходом за рамки MVP и требует пересмотра архитектуры.

## Связанные документы

- `ctx/docs/architecture/data-flow/attention.md` — Attention flows.
- `ctx/docs/architecture/ingress/http-ingress.md` — HTTP ingress.
- `ctx/docs/architecture/ingress/attention-write-ingress.md` — write-ingress сигналов внимания.

## Итог

Документ фиксирует anonymous identity как техническую сущность write-path, не являющуюся пользователем и не вводящую персонализации, а также задаёт инварианты её регистрации и использования в MVP Mindstream.
