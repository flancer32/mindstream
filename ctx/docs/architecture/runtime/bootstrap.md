# Запуск backend-приложения

Path: `./ctx/docs/architecture/runtime/bootstrap.md`

## Назначение

Документ фиксирует архитектурную модель запуска backend-приложения и границу ответственности между **bootstrap-слоем** и **приложением**.

Запуск рассматривается как передача управления от среды исполнения к корневому объекту приложения через заранее сформированный composition root.

---

## Архитектурный принцип

Backend-приложение **не управляет своим запуском** и **не знает**, каким способом оно было инициализировано.

Bootstrap-код является внешним по отношению к приложению и отвечает исключительно за подготовку среды исполнения и формирование composition root.

---

## Ответственность bootstrap-кода

Bootstrap-код обязан:

- определить физический корень проекта в файловой системе;
- инициализировать DI-контейнер;
- сконфигурировать composition root (namespace roots и обязательные DI-инварианты);
- получить корневой объект приложения из контейнера;
- передать управление приложению.

Bootstrap-код не интерпретирует окружение и не содержит продуктовых решений.

---

## Ответственность приложения

Приложение обязано:

- принимать управление через единый корневой объект;
- самостоятельно работать с окружением (env, режимы, конфигурации);
- управлять своим жизненным циклом;
- не модифицировать composition root.

---

## Контракт передачи управления

Единственным допустимым параметром, передаваемым из bootstrap-кода в приложение, является:

- `projectRoot` — абсолютный путь к корню проекта в файловой системе.

Контейнер зависимостей, параметры окружения, режимы работы и инфраструктурные настройки **не передаются**.

---

## Инварианты

Считается нарушением архитектуры, если bootstrap-код:

- читает или интерпретирует env-переменные;
- содержит бизнес- или продуктовую логику;
- управляет жизненным циклом приложения;
- передаёт контейнер в приложение;
- принимает решения, зависящие от режима работы или конфигурации продукта.

---

## Эталонная реализация (Node.js, ESM)

Приведённый ниже код является **референсной реализацией** архитектурного решения для Node.js и не определяет архитектуру сам по себе.

```js
#!/usr/bin/env node

import path from "node:path";
import { fileURLToPath } from "node:url";
import Container from "@teqfw/di";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, "..");

const container = new Container();
const resolver = container.getResolver();

resolver.addNamespaceRoot("Mindstream_Back_", path.join(projectRoot, "src"), "mjs");
resolver.addNamespaceRoot("Mindstream_Shared_", path.join(projectRoot, "web", "app", "Shared"), "mjs");
resolver.addNamespaceRoot("Teqfw_Di_", path.join(projectRoot, "node_modules", "@teqfw", "di", "src"));

const app = await container.get("Mindstream_Back_App$");
await app.run({ projectRoot });
```

---

## Проверка корректности границы

Архитектура считается корректной, если:

- bootstrap-код можно заменить без изменения приложения;
- приложение можно запустить альтернативным bootstrap-кодом без изменений;
- расширение логики запуска не требует изменения bootstrap-кода.

---

## Примечание

Документ фиксирует **архитектуру запуска**, а не конкретный способ деплоя, CI/CD или окружения исполнения.
