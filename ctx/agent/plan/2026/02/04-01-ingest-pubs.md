# Mindstream — Ingestion Development Plan (MVP)

Документ фиксирует поэтапный план разработки ingestion-контура Mindstream.  
План выстроен по зависимостям: каждая следующая область опирается на предыдущие.  
Разработка ведётся последовательно, без пропусков и параллелизации областей.

---

## Область 1. Sources & Identity

**Цель:** зафиксировать модель источников публикаций и каноническую идентификацию публикаций.

Задачи:

- ввести сущность `Source` с уникальным `source_id`;
- зафиксировать контракт вычисления `source_item_hash` как source-specific функции;
- определить формат канонического ключа публикации `(source_id, source_item_hash)`;
- зафиксировать правило идемпотентности на уровне ключа;
- документировать, что URL не является каноническим ключом.

Результат:

- декларативная модель источников;
- однозначный и расширяемый механизм идентификации публикаций.

---

## Область 2. Publication Core Model

**Цель:** определить каноническую сущность публикации и её жизненный цикл.

Задачи:

- зафиксировать сущность `Publication` как “голову” всех связанных артефактов;
- определить набор статусов публикации (state machine);
- зафиксировать явный флаг готовности к Primary Processing;
- определить инварианты идемпотентности и необратимости состояний;
- определить минимальный набор timestamps и счётчиков попыток.

Результат:

- формальная статусная модель публикации;
- прозрачное управление жизненным циклом ingestion → processing.

---

## Область 3. Storage Schema (PostgreSQL)

**Цель:** спроектировать нормализованную схему хранения ingestion-данных.

Задачи:

- спроектировать таблицу `source`;
- спроектировать таблицу `publication` с UNIQUE `(source_id, source_item_hash)`;
- спроектировать таблицы для артефактов:
  - raw HTML;
  - нормализованный текст публикации;
- определить использование `jsonb` для source-specific metadata;
- зафиксировать отсутствие денормализованных “широких” таблиц.

Результат:

- минимальная, нормализованная схема БД;
- база для идемпотентного и расширяемого ingestion.

---

## Область 4. Discovery (RSS Ingestion)

**Цель:** реализовать обнаружение публикаций без загрузки полного текста.

Задачи:

- определить RSS как источник ссылок, а не текста;
- реализовать ingestion RSS-лент в виде discovery-потока;
- извлекать минимальные метаданные (url, даты, заголовок, rss-meta);
- выполнять idempotent upsert публикаций по каноническому ключу;
- исключить любые побочные эффекты за пределами `publication`.

Результат:

- стабильный и повторяемый discovery-процесс;
- пополнение корпуса “известных” публикаций.

---

## Область 5. Fetch & Text Extraction

**Цель:** получить и подготовить текст публикации для смысловой обработки.

Задачи:

- загрузка HTML по `source_url`;
- сохранение raw HTML как вспомогательного артефакта;
- извлечение очищенного текста (без комментариев, картинок, UI);
- сохранение нормализованного текста отдельной сущностью;
- выставление флага/статуса готовности к Primary Processing.

Результат:

- публикации, полностью готовые к смысловой обработке;
- трассируемость от raw HTML к очищенному тексту.

---

## Область 6. Ingestion Control & Errors

**Цель:** обеспечить устойчивость и наблюдаемость ingestion.

Задачи:

- реализовать счётчик попыток загрузки/извлечения;
- зафиксировать правило “3 попытки → rejected”;
- исключить повторную обработку rejected-публикаций;
- логировать причины ошибок без хранения их в данных;
- обеспечить строгую идемпотентность повторных запусков.

Результат:

- контролируемый и самостабилизирующийся ingestion;
- отсутствие бесконечных циклов и повторов.

---

## Область 7. CLI & Scheduling

**Цель:** предоставить управляемую точку входа для ingestion.

Задачи:

- реализовать CLI-интерфейс ingestion:
  - discovery;
  - fetch/extract;
  - полный run;
- обеспечить возможность инкрементального запуска;
- подготовить CLI к использованию в cron без изменения логики;
- зафиксировать CLI как единственную точку управления ingestion.

Результат:

- воспроизводимый ingestion-процесс;
- готовность к автоматическому запуску.

---

## Итоговая зависимость областей

1. Sources & Identity
2. Publication Core Model
3. Storage Schema
4. Discovery (RSS)
5. Fetch & Text Extraction
6. Ingestion Control & Errors
7. CLI & Scheduling

Переход к следующей области допускается только после завершения предыдущей.
